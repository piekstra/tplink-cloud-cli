name: Test & Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libdbus-1-dev pkg-config
      - run: cargo fmt --check
      - run: cargo clippy -- -D warnings
      - run: cargo test --verbose

  build:
    needs: check
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            artifact: tplc-linux-x86_64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            artifact: tplc-linux-aarch64
          - target: x86_64-apple-darwin
            os: macos-latest
            artifact: tplc-macos-x86_64
          - target: aarch64-apple-darwin
            os: macos-latest
            artifact: tplc-macos-aarch64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            artifact: tplc-windows-x86_64.exe
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libdbus-1-dev pkg-config
          if [[ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]]; then
            sudo dpkg --add-architecture arm64
            # arm64 packages live on ports.ubuntu.com, not the default amd64 mirrors.
            # Pin existing sources to amd64-only, then add ports for arm64.
            # Lines without brackets: deb http... -> deb [arch=amd64] http...
            # Lines with brackets: deb [opts] -> deb [arch=amd64,opts]
            for f in /etc/apt/sources.list /etc/apt/sources.list.d/*.list; do
              [ -f "$f" ] || continue
              sudo sed -i -e 's/^deb \(http\)/deb [arch=amd64] \1/' -e 's/^deb \[/deb [arch=amd64,/' "$f"
            done
            sudo sed -i '/^Architectures:/d; /^Types:/a Architectures: amd64' /etc/apt/sources.list.d/*.sources 2>/dev/null || true
            printf 'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports noble main universe\ndeb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports noble-updates main universe\ndeb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports noble-security main universe\n' | sudo tee /etc/apt/sources.list.d/arm64-cross.list
            sudo apt-get update
            sudo apt-get install -y gcc-aarch64-linux-gnu libdbus-1-dev:arm64
            echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
            echo "PKG_CONFIG_SYSROOT_DIR=/usr/aarch64-linux-gnu" >> $GITHUB_ENV
          fi

      - run: cargo build --release --target ${{ matrix.target }}

      - name: Rename binary
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            cp target/${{ matrix.target }}/release/tplc.exe ${{ matrix.artifact }}
          else
            cp target/${{ matrix.target }}/release/tplc ${{ matrix.artifact }}
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}

  release:
    needs: build
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Determine version
        id: bump
        run: |
          BASE_VERSION=$(cat version.txt | tr -d '\n')
          VERSION="${BASE_VERSION}.${GITHUB_RUN_NUMBER}"
          ./scripts/bump-version.sh "$VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git tag "v${{ steps.bump.outputs.version }}"
          git push origin "v${{ steps.bump.outputs.version }}"
          gh release create "v${{ steps.bump.outputs.version }}" \
            tplc-* \
            --title "v${{ steps.bump.outputs.version }}" \
            --generate-notes

      - name: Update Homebrew formula
        env:
          GH_TOKEN: ${{ secrets.TAP_TOKEN }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "TAP_TOKEN secret not set, skipping Homebrew update"
            exit 0
          fi

          SHA256_MACOS_ARM=$(shasum -a 256 tplc-macos-aarch64 | awk '{print $1}')
          SHA256_MACOS_X86=$(shasum -a 256 tplc-macos-x86_64 | awk '{print $1}')
          SHA256_LINUX_X86=$(shasum -a 256 tplc-linux-x86_64 | awk '{print $1}')
          SHA256_LINUX_ARM=$(shasum -a 256 tplc-linux-aarch64 | awk '{print $1}')
          VERSION="${{ steps.bump.outputs.version }}"
          BASE_URL="https://github.com/piekstra/tplink-cloud-cli/releases/download/v${VERSION}"

          cat > /tmp/tplc.rb <<RUBY
          class Tplc < Formula
            desc "CLI for TP-Link Cloud API - control Kasa and Tapo smart home devices"
            homepage "https://github.com/piekstra/tplink-cloud-cli"
            license "GPL-3.0"
            version "${VERSION}"

            on_macos do
              if Hardware::CPU.arm?
                url "${BASE_URL}/tplc-macos-aarch64"
                sha256 "${SHA256_MACOS_ARM}"
              else
                url "${BASE_URL}/tplc-macos-x86_64"
                sha256 "${SHA256_MACOS_X86}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "${BASE_URL}/tplc-linux-aarch64"
                sha256 "${SHA256_LINUX_ARM}"
              else
                url "${BASE_URL}/tplc-linux-x86_64"
                sha256 "${SHA256_LINUX_X86}"
              end
            end

            def install
              binary = Dir["tplc-*"].first || "tplc"
              mv binary, "tplc"
              bin.install "tplc"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/tplc --version")
            end
          end
          RUBY

          # Strip leading whitespace from heredoc
          sed -i '' 's/^          //' /tmp/tplc.rb

          CONTENT=$(base64 -i /tmp/tplc.rb)
          EXISTING_SHA=$(gh api repos/piekstra/homebrew-tap/contents/Formula/tplc.rb --jq '.sha' 2>/dev/null || echo "")

          if [ -n "$EXISTING_SHA" ]; then
            gh api repos/piekstra/homebrew-tap/contents/Formula/tplc.rb \
              -X PUT \
              -f message="Update tplc to v${VERSION}" \
              -f content="${CONTENT}" \
              -f sha="${EXISTING_SHA}"
          else
            gh api repos/piekstra/homebrew-tap/contents/Formula/tplc.rb \
              -X PUT \
              -f message="Add tplc v${VERSION}" \
              -f content="${CONTENT}"
          fi
